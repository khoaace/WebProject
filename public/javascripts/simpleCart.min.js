var countProduct =0;
var price=0;
var priceShow=0;
var row=1;
var arrProduct=[];
var fisrtConnect = true;
if(fisrtConnect)
{
    arrProduct =JSON.parse(localStorage.getItem("checkout") || "[]");
    loadTable();
    fisrtConnect = false;
}
function loadTable() {
    // Xoá hết phần tử cũ
    if(countProduct != 0) {
        for (var i = row; i > 0; i--) {
            document.getElementById('productTable').deleteRow(i);
        }
    }
    // Tải lại bảng
    row=1;
    countProduct = arrProduct.length;
    price=0;
    for(var i=0;i<arrProduct.length;i++)
    {
        priceShow = parseInt(arrProduct[i].price);
        priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
            return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
        });
        var myTable = document.getElementById("productTable").insertRow(row);
        var tbProductName = myTable.insertCell(0);
        var tbProductCount  = myTable.insertCell(1);
        var tbProductPrice = myTable.insertCell(2);
        var tbDeleteProduct = myTable.insertCell(3);
        tbProductName.setAttribute("style","font-weight:bold;color:green;");
        tbProductPrice.setAttribute("style","font-weight:bold;color:black;");

        tbDeleteProduct.innerHTML ='<a href="#" onclick="deleteProduct('+row+','+priceShow+');"><span class="glyphicon glyphicon-remove"></span></a>';
        tbProductName.innerHTML=arrProduct[i].name;
        tbProductCount.innerHTML = '<input type="number" name="productCount" id="productCount'+row+'" class="cart_quantity_input" value="'+arrProduct[i].count+'" onchange="SomeScriptMethod('+row+','+arrProduct[i].count+');" onkeyup="this.value=this.value.replace(/[^\\d]/,\'\')" min="1" required value="">';
        tbProductPrice.innerHTML = priceShow;
        row++;
        //Load Tổng tiền
        price = parseInt(price) + parseInt(arrProduct[i].price);
    }
    priceShow = price;
    priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
        return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
    });
    $("#yourPrice").html(priceShow);
    $("#countProduct").html(arrProduct.length);
    localStorage.setItem("checkout", JSON.stringify(arrProduct));
};
$(document).ready(function() {
    $('#myModal').modal({
        backdrop: 'static',
        keyboard: true,
        show: false
    });
    $('.closeLink').click( function(event) {
        event.preventDefault();
    });
    $("#resetProduct").on('click',function(event) {
        $("#snackbar").html('Giỏ hàng trống');
        var x = document.getElementById("snackbar");
        // Add the "show" class to DIV
        x.className = "show";
        // After 3 seconds, remove the show class from DIV
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        price=0;
        $("#countProduct").html(countProduct);
        $("#yourPrice").html(0);
        //Xoá dữ liệu trong bảng
        arrProduct = [];
        row--;
        loadTable();
        countProduct=0;
        // Lưu vào local store
        localStorage.setItem("checkout", JSON.stringify(arrProduct));
    });

});

function addItem(productName,productPrice,productImage,productID) {
   /*------------------ Hiện thông báo -------------------------*/
    $("#snackbar").html('Đã thêm '+productName+' vào giỏ hàng');
    var x = document.getElementById("snackbar");
    // Add the "show" class to DIV
    x.className = "show";
    // After 3 seconds, remove the show class from DIV
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    /*------------------ xử lý -------------------------*/
    updateArrayProduct(productID,productName,productPrice,-1);
    row--;
    loadTable();
};


function deleteProduct(stt,tbprice) {
    stt--;
    row--;
    arrProduct.splice(stt, 1);
    loadTable();
    // Lưu vào local store
    localStorage.setItem("checkout", JSON.stringify(arrProduct));
};
function SomeScriptMethod(tbrow) {
    pos= tbrow - 1;
    var id='productCount'+tbrow;
    var value= $("#"+id).val();
    if(value == "" || parseInt(value)==0)
    {
        deleteProduct(tbrow,arrProduct[pos].price);
    }
    else {
        updateArrayProduct(arrProduct[pos].id, arrProduct[pos].name, arrProduct[pos].price, value);
        row--;
        loadTable();
    }
}

function updateArrayProduct(id,name,price,count) {
    var finded = false;
    for(var i=0;i<arrProduct.length;i++)
    {
        if(id == arrProduct[i].id)
        {
            if(count == -1)
            arrProduct[i].count++;
            else
                arrProduct[i].count = parseInt(count);
            arrProduct[i].price = parseInt(arrProduct[i].rootprice)*parseInt(arrProduct[i].count);
            finded =true;
        }
    }
    if(!finded)
    {
        arrProduct.push({name:name,price:price,count:1,id:id,rootprice:price})
    }
}