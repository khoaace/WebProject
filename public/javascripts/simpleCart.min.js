var countProduct =0;
var price=0;
var priceShow=0;
var row=1;
var arrProduct=[];
var fisrtConnect = true;
if(fisrtConnect)
{
    arrProduct =JSON.parse(localStorage.getItem("checkout") || "[]");
    loadTable();
    fisrtConnect = false;
}

function loadTable() {
    // Xoá hết phần tử cũ
    if(countProduct != 0) {
        for (var i = row; i > 0; i--) {
            document.getElementById('productTable').deleteRow(i);
        }
    }
    // Tải lại bảng
    row=1;
    countProduct = arrProduct.length;
    price=0;
    for(var i=0;i<arrProduct.length;i++)
    {
        priceShow = parseInt(arrProduct[i].price);
        priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
            return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
        });
        var myTable = document.getElementById("productTable").insertRow(row);
        var tbProductName = myTable.insertCell(0);
        var tbProductCount  = myTable.insertCell(1);
        var tbProductPrice = myTable.insertCell(2);
        var tbDeleteProduct = myTable.insertCell(3);
        tbProductName.setAttribute("style","font-weight:bold;color:green;");
        tbProductPrice.setAttribute("style","font-weight:bold;color:black;");

        tbDeleteProduct.innerHTML ='<a href="#" onclick="deleteProduct('+row+','+priceShow+');"><span class="glyphicon glyphicon-remove"></span></a>';
        tbProductName.innerHTML=arrProduct[i].name;
        tbProductCount.innerHTML = '<input type="number" name="productCount" id="productCount'+row+'" class="cart_quantity_input" value="'+arrProduct[i].count+'" onchange="SomeScriptMethod('+row+','+arrProduct[i].count+');" onkeyup="this.value=this.value.replace(/[^\\d]/,\'\')" min="1" required value="">';
        tbProductPrice.innerHTML = priceShow;
        row++;
        //Load Tổng tiền
        price = parseInt(price) + parseInt(arrProduct[i].price);
    }
    priceShow = price;
    priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
        return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
    });
    $("#yourPrice").html(priceShow);
    $("#countProduct").html(arrProduct.length);
    localStorage.setItem("checkout", JSON.stringify(arrProduct));
};


var data;
$(document).ready(function() {
    $('input[type=radio][name=thanhtoan]').change(function() {
        if (this.value == 'COD') {
            $("#bankInput").empty();
        }
        else if (this.value == 'BANK') {
            $("#bankInput").html('<div class="form-horizontal"><label>Tên chủ thẻ </label><input type="text"><br><br><label>Số tài khoản</label><input type="text"></div>');
        }
    });

    $('#myModal').modal({
        backdrop: 'static',
        keyboard: true,
        show: false
    });
    $('.closeLink').click( function(event) {
        event.preventDefault();
    });
    $("#resetProduct").on('click',function(event) {
        $("#snackbar").html('Giỏ hàng trống');
        var x = document.getElementById("snackbar");
        // Add the "show" class to DIV
        x.className = "show";
        // After 3 seconds, remove the show class from DIV
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        price=0;
        $("#countProduct").html(countProduct);
        $("#yourPrice").html(0);
        //Xoá dữ liệu trong bảng
        arrProduct = [];
        row--;
        loadTable();
        countProduct=0;
        // Lưu vào local store
        localStorage.setItem("checkout", JSON.stringify(arrProduct));
    });

});

function addItem(productName,productPrice,productImage,productID) {
   /*------------------ Hiện thông báo -------------------------*/
    $("#snackbar").html('Đã thêm '+productName+' vào giỏ hàng');
    var x = document.getElementById("snackbar");
    // Add the "show" class to DIV
    x.className = "show";
    // After 3 seconds, remove the show class from DIV
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    /*------------------ xử lý -------------------------*/
    updateArrayProduct(productID,productName,productPrice,-1);
    row--;
    loadTable();
};


function deleteProduct(stt,tbprice) {
    stt--;
    row--;
    arrProduct.splice(stt, 1);
    loadTable();
    loadTableCheckout();
    // Lưu vào local store
    localStorage.setItem("checkout", JSON.stringify(arrProduct));
};
function SomeScriptMethod(tbrow) {
    pos= tbrow - 1;
    var id='productCount'+tbrow;
    var value= $("#"+id).val();
    if(value == "" || parseInt(value)==0)
    {
        deleteProduct(tbrow,arrProduct[pos].price);
    }
    else {
        updateArrayProduct(arrProduct[pos].id, arrProduct[pos].name, arrProduct[pos].price, value);
        row--;

        loadTable();
    }
    loadTableCheckout();
}

function updateArrayProduct(id,name,price,count) {
    var finded = false;
    for(var i=0;i<arrProduct.length;i++)
    {
        if(id == arrProduct[i].id)
        {
            if(count == -1)
            arrProduct[i].count++;
            else
                arrProduct[i].count = parseInt(count);
            arrProduct[i].price = parseInt(arrProduct[i].rootprice)*parseInt(arrProduct[i].count);
            finded =true;
        }
    }
    if(!finded)
    {
        arrProduct.push({name:name,price:price,count:1,id:id,rootprice:price})
    }
}

loadTableCheckout();
function loadTableCheckout() {
    // Tải lại bảng
    var ck_row=1;
    var ck_price=0;
    $("#productTablecheckout").empty();
    $("#productTablecheckout").html('<tr>\n' +
        '            <th>Tên sản phẩm</th>\n' +
        '            <th>Số lượng</th>\n' +
        '            <th>Giá</th>\n' +
        '        </tr>');
    for(var i=0;i<arrProduct.length;i++)
    {
        priceShow = parseInt(arrProduct[i].price);
        priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
            return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
        });
        var ck_myTable = document.getElementById("productTablecheckout").insertRow(ck_row);
        var ck_tbProductName = ck_myTable.insertCell(0);
        var ck_tbProductCount  = ck_myTable.insertCell(1);
        var ck_tbProductPrice = ck_myTable.insertCell(2);
        ck_tbProductName.setAttribute("style","font-weight:bold;color:green;");
        ck_tbProductPrice.setAttribute("style","font-weight:bold;color:black;");


        ck_tbProductName.innerHTML=arrProduct[i].name;
        ck_tbProductCount.innerHTML = '<input type="number" name="productCount" id="productCount'+ck_row+'" class="cart_quantity_input" value="'+arrProduct[i].count+'" min="1" readonly>';
        ck_tbProductPrice.innerHTML = priceShow;
        ck_row++;
        //Load Tổng tiền
        ck_price = parseInt(ck_price) + parseInt(arrProduct[i].price);
    }

    priceShow = 30000;
    priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
        return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
    });
    if(ck_price < 200000 && ck_price>0)
    {
        $("#yourShipcheckout").html(priceShow);
        ck_price=ck_price+30000;
    }
    else
    {
        $("#yourShipcheckout").html(0);
    }
    priceShow = ck_price;
    priceShow = priceShow.toFixed(0).replace(/./g, function(c, i, a) {
        return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
    });
    $("#yourPricecheckout").html(priceShow);
    $("#countProductcheckout").html(arrProduct.length);
};


////////////////////////////// XỬ LÝ ĐẶT HÀNG //////////////////////////////////

$(document).ready(function () {
    $("#dathang").click(function (event) {
        event.preventDefault();
        // Kiễm tra dữ liệu nhập
        var err = false;
        if($("#tenkhachhang").val().trim() == "" || $("#sodienthoai").val().trim() == "" ||$("#diachinhanhang").val().trim() == "")
        {
            $("#snackbar").html('Chưa điền dầy đủ thông tin.');
            var x = document.getElementById("snackbar");
            // Add the "show" class to DIV
            x.className = "show";
            // After 3 seconds, remove the show class from DIV
            setTimeout(function () {
                x.className = x.className.replace("show", "");
            }, 3000);
            err=true;
        }
        if(!$.isNumeric($("#sodienthoai").val()))
        {
            err=true;
            $("#snackbar").html('Số điện thoại chỉ bao gồm các kí tự số');
            var x = document.getElementById("snackbar");
            // Add the "show" class to DIV
            x.className = "show";
            // After 3 seconds, remove the show class from DIV
            setTimeout(function () {
                x.className = x.className.replace("show", "");
            }, 3000);
        }
        if(arrProduct.length == 0)
        {
            err=true;
            $("#snackbar").html('Chưa có sản phẫm trong giỏ hàng');
            var x = document.getElementById("snackbar");
            // Add the "show" class to DIV
            x.className = "show";
            // After 3 seconds, remove the show class from DIV
            setTimeout(function () {
                x.className = x.className.replace("show", "");
            }, 3000);
        }
        if(!err) {
            var dataProduct = [];
            for (var i = 0; i < arrProduct.length; i++) {
                dataProduct.push(arrProduct[i].id);
            }
            var dataQuatity = [];
            for (var i = 0; i < arrProduct.length; i++) {
                dataQuatity.push(parseInt(arrProduct[i].count));
            }
            var dataPrice = [];
            for (var i = 0; i < arrProduct.length; i++) {
                dataPrice.push(parseInt(arrProduct[i].rootprice));
            }

            data = {
                'tenkhachhang': $("#tenkhachhang").val(),
                'idthanhvien': $("#idthanhvien").val(),
                'sodienthoai': $("#sodienthoai").val(),
                'diachinhanhang': $("#diachinhanhang").val(),
                'thanhtoan': $("#thanhtoan").val(),
                'ghichu': $("#ghichu").val(),
                'sanpham': dataProduct,
                'soluong': dataQuatity,
                'gia': dataPrice
            };
            /*  ------------Gửi Data --------------*/
            $.ajax({
                type: 'POST',
                url: '/checkout',
                data: data
            }).done(function (data) {
                $("#snackbar").html('Đặt mua thành công');
                var x = document.getElementById("snackbar");
                // Add the "show" class to DIV
                x.className = "show";
                // After 3 seconds, remove the show class from DIV
                setTimeout(function () {
                    x.className = x.className.replace("show", "");
                }, 3000);
                //Reset form
                $("#tenkhachhang").val("");
                $("#sodienthoai").val("");
                $("#diachinhanhang").val("");
                $("#ghichu").val("");
            }).fail(function (data) {
                $("#snackbar").html('Thất bại');
                var x = document.getElementById("snackbar");
                // Add the "show" class to DIV
                x.className = "show";
                // After 3 seconds, remove the show class from DIV
                setTimeout(function () {
                    x.className = x.className.replace("show", "");
                }, 3000);
            });
        }
    });

});
function getModalDonHang(id) {
    var dataCheck={'id':id};
    $.ajax({
        type: 'POST',
        url: '/profile/checkout',
        data: dataCheck
    }).done(function (data) {
        //Reset form
        var info='<div>\n' +
            '    <label class="col-md-4 control-label" for="orderdetail_id_textinput">Mã đơn hàng</label>\n' +
            '    <div class="col-md-8">\n' +
            '        <input id="orderdetail_id_textinput" name="id" type="text" value="'+id+'" class="form-control input-md" disabled>\n' +
            '    </div>\n' +
            '</div>\n' +
            '\n' +
            '<div>\n' +
            '    <label class="col-md-4 control-label" for="orderdetail_name_textinput">Họ tên khách hàng</label>\n' +
            '    <div class="col-md-8">\n' +
            '        <input id="orderdetail_name_textinput" name="ten" type="text" value="'+data.tenkhachhang+'" class="form-control input-md" disabled>\n' +
            '    </div>\n' +
            '</div>\n' +
            '\n' +
            '<div>\n' +
            '    <label class="col-md-4 control-label" for="orderdetail_add_textinput">Địa chỉ giao</label>\n' +
            '    <div class="col-md-8">\n' +
            '        <input id="orderdetail_add_textinput" name="diachi" type="text" value="'+data.diachi+'" class="form-control input-md"  required="" oninvalid="this.setCustomValidity(\'Chưa nhập tên nhãn hiệu\')" oninput="setCustomValidity(\'\')" disabled>\n' +
            '    </div>\n' +
            '</div>\n' +
            '\n' +
            '<div>\n' +
            '    <label class="col-md-4 control-label" for="orderdetail_phone_textinput">Số điện thoại</label>\n' +
            '    <div class="col-md-8">\n' +
            '        <input id="orderdetail_phone_textinput" name="sodienthoai" type="text" value="'+data.sodienthoai+'" class="form-control input-md" disabled>\n' +
            '    </div>\n' +
            '</div>\n' +
            '\n' +
            '<div>\n' +
            '    <label class="col-md-4 control-label" for="orderdetail_time_textinput">Thời gian nhận đơn</label>\n' +
            '    <div class="col-md-8">\n' +
            '        <input id="orderdetail_time_textinput" name="thoigian" type="text" value="'+data.ngaynhandon+'" class="form-control input-md" disabled>\n' +
            '    </div>\n' +
            '</div>\n' +
            '\n' +
            '<div class="form-group">\n' +
            '    <label class="col-md-4 control-label" for="orderdetail_note_textinput">Ghi chú</label>\n' +
            '    <div class="col-md-8">\n' +
            '        <textarea class="form-control" id="orderdetail_note_textinput" value="'+data.ghichu+'" name="note"></textarea>\n' +
            '    </div>\n' +
            '</div><br><br>';
        var table=info+'<br><table class="table table-bordered theodoitable"><tr><th>Tên sản phẩm</th><th>Số lượng</th><th>Đơn giá</th><th>Tổng tiền</th></tr>';
        for(var i=0;i<data.sanpham.length;i++)
        {
            table =table + '<tr><td>'+data.sanpham[i].ten+'</td><td>'+data.soluong[i]+'</td><td>'+data.gia[i]+'</td><td>'+data.thanhtien[i]+'</td></tr>';
        }
        table=table+'</table>'+'<div class="shipPrice">Phí giao hàng : <span id="yourShipcheckout" style="color: red;"></span>'+ data.shipfee+' (VND)</div>\n' +
            '<br><br>\n' +
            '    <div class="price-sum">Tổng tiền : <span id="yourPricecheckout" style="color: red;font-size: 30px;">'+data.tongcong+'</span> (VND)</div><br><br>';
        $("#modalbodygiohang").html(table);
        $("#ModalGioHang").modal();

    }).fail(function (data) {
        $("#snackbar").html('Thất bại');
        var x = document.getElementById("snackbar");
        // Add the "show" class to DIV
        x.className = "show";
        // After 3 seconds, remove the show class from DIV
        setTimeout(function () {
            x.className = x.className.replace("show", "");
        }, 3000);
    });

};